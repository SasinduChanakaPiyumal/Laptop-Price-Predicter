#!/usr/bin/env python3
"""
Vulnerability Scanning Script

This script automates the dependency vulnerability scanning process
as defined in SECURITY.md using pip-audit.

Usage:
    python run_vulnerability_scan.py

Output:
    - vulnerability_scan_results.txt: Full scan output
    - Console: Summary of findings
"""

import subprocess
import sys
from datetime import datetime
import os


def check_pip_audit_installed():
    """Check if pip-audit is installed, install if not."""
    try:
        subprocess.run(
            ['pip-audit', '--version'],
            capture_output=True,
            check=True,
            text=True
        )
        print("✓ pip-audit is installed")
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("⚠ pip-audit not found. Installing...")
        try:
            subprocess.run(
                [sys.executable, '-m', 'pip', 'install', 'pip-audit'],
                check=True
            )
            print("✓ pip-audit installed successfully")
            return True
        except subprocess.CalledProcessError as e:
            print(f"✗ Failed to install pip-audit: {e}")
            return False


def run_vulnerability_scan():
    """Execute pip-audit scan against requirements.txt."""
    print("\n" + "="*60)
    print("DEPENDENCY VULNERABILITY SCAN")
    print("="*60)
    print(f"Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Tool: pip-audit")
    print(f"Target: requirements.txt")
    print("="*60 + "\n")
    
    # Check if requirements.txt exists
    if not os.path.exists('requirements.txt'):
        print("✗ Error: requirements.txt not found")
        return None
    
    try:
        # Run pip-audit with requirements.txt
        result = subprocess.run(
            ['pip-audit', '-r', 'requirements.txt'],
            capture_output=True,
            text=True,
            timeout=300  # 5 minute timeout
        )
        
        # Combine stdout and stderr
        output = f"""Dependency Vulnerability Scan Results
Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Command: pip-audit -r requirements.txt

{'='*60}
STDOUT:
{'='*60}
{result.stdout}

{'='*60}
STDERR:
{'='*60}
{result.stderr}

{'='*60}
EXIT CODE: {result.returncode}
{'='*60}
"""
        
        # Save results to file
        with open('vulnerability_scan_results.txt', 'w', encoding='utf-8') as f:
            f.write(output)
        
        print("✓ Scan completed")
        print(f"✓ Results saved to: vulnerability_scan_results.txt")
        
        # Print summary
        print("\n" + "="*60)
        print("SCAN OUTPUT:")
        print("="*60)
        print(result.stdout)
        
        if result.stderr:
            print("\n" + "="*60)
            print("ERRORS/WARNINGS:")
            print("="*60)
            print(result.stderr)
        
        # Determine scan status
        if result.returncode == 0:
            print("\n✓ SUCCESS: No vulnerabilities found!")
        else:
            print(f"\n⚠ VULNERABILITIES DETECTED (exit code: {result.returncode})")
            print("→ Review vulnerability_scan_results.txt for details")
            print("→ Update SECURITY.md with findings")
        
        return output
        
    except subprocess.TimeoutExpired:
        error_msg = "✗ Error: Scan timed out after 5 minutes"
        print(error_msg)
        return error_msg
    except Exception as e:
        error_msg = f"✗ Error running scan: {e}"
        print(error_msg)
        return error_msg


def main():
    """Main execution function."""
    print("\nStarting Dependency Vulnerability Scan Process...")
    print("Following procedures defined in SECURITY.md\n")
    
    # Step 1: Check/install pip-audit
    if not check_pip_audit_installed():
        print("\n✗ Cannot proceed without pip-audit")
        sys.exit(1)
    
    # Step 2: Run scan
    result = run_vulnerability_scan()
    
    if result is None:
        sys.exit(1)
    
    print("\n" + "="*60)
    print("NEXT STEPS:")
    print("="*60)
    print("1. Review vulnerability_scan_results.txt")
    print("2. Update SECURITY.md with findings")
    print("3. Address any vulnerabilities found:")
    print("   - Update version pins in requirements.in")
    print("   - Recompile: pip-compile --generate-hashes -o requirements.txt requirements.in")
    print("   - Re-run this scan")
    print("="*60 + "\n")


if __name__ == "__main__":
    main()
